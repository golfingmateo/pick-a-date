<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Console - Pick a Date</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: white;
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        h1 {
            color: #1e293b;
            font-size: 32px;
            margin-bottom: 10px;
        }

        .subtitle {
            color: #64748b;
            font-size: 16px;
        }

        .login-container {
            max-width: 400px;
            margin: 100px auto;
            background: white;
            border-radius: 16px;
            padding: 40px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .login-container h2 {
            color: #1e293b;
            margin-bottom: 20px;
        }

        .login-container input {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 16px;
            margin-bottom: 20px;
        }

        .login-container input:focus {
            outline: none;
            border-color: #3b82f6;
        }

        .login-container button {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
        }

        .login-container button:hover {
            opacity: 0.9;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .stat-number {
            font-size: 36px;
            font-weight: 700;
            color: #3b82f6;
        }

        .stat-label {
            color: #64748b;
            font-size: 14px;
            margin-top: 5px;
        }

        .events-section {
            background: white;
            border-radius: 16px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .filters {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 10px 20px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s ease;
        }

        .filter-btn:hover {
            background: #f8fafc;
        }

        .filter-btn.active {
            background: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }

        .search-box {
            flex: 1;
            min-width: 250px;
            padding: 10px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 16px;
        }

        .search-box:focus {
            outline: none;
            border-color: #3b82f6;
        }

        .event-table {
            width: 100%;
            border-collapse: collapse;
        }

        .event-table th {
            background: #f8fafc;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            color: #475569;
            border-bottom: 2px solid #e2e8f0;
        }

        .event-table td {
            padding: 16px 12px;
            border-bottom: 1px solid #f1f5f9;
        }

        .event-table tr:hover {
            background: #f8fafc;
        }

        .event-title {
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 4px;
        }

        .event-meta {
            font-size: 13px;
            color: #64748b;
        }

        .color-badge {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            display: inline-block;
            border: 2px solid #e2e8f0;
        }

        .action-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            margin-right: 8px;
            transition: all 0.2s ease;
        }

        .btn-view {
            background: #3b82f6;
            color: white;
        }

        .btn-view:hover {
            background: #2563eb;
        }

        .btn-dashboard {
            background: #10b981;
            color: white;
        }

        .btn-dashboard:hover {
            background: #059669;
        }

        .btn-delete {
            background: #ef4444;
            color: white;
        }

        .btn-delete:hover {
            background: #dc2626;
        }

        .response-count {
            display: inline-block;
            background: #dbeafe;
            color: #1e40af;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 13px;
            font-weight: 600;
        }

        .response-count.full {
            background: #fee2e2;
            color: #991b1b;
        }

        .no-events {
            text-align: center;
            padding: 60px;
            color: #94a3b8;
            font-size: 18px;
        }

        .loading {
            text-align: center;
            padding: 60px;
            color: #64748b;
        }

        @media (max-width: 768px) {
            .event-table {
                font-size: 14px;
            }

            .event-table th,
            .event-table td {
                padding: 8px;
            }

            .action-btn {
                display: block;
                width: 100%;
                margin-bottom: 5px;
            }
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="loginScreen" class="login-container">
        <h2>üîê Admin Console</h2>
        <p style="color: #64748b; margin-bottom: 20px;">Enter admin password to continue</p>
        <input type="password" id="adminPassword" placeholder="Admin Password" onkeypress="if(event.key==='Enter') login()">
        <button onclick="login()">Login</button>
        <p id="loginError" style="color: #ef4444; margin-top: 15px; display: none;">Incorrect password</p>
    </div>

    <!-- Admin Console -->
    <div id="adminConsole" style="display: none;">
        <div class="container">
            <div class="header">
                <h1>üõ†Ô∏è Admin Console</h1>
                <p class="subtitle">View and manage all events</p>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="totalEvents">-</div>
                    <div class="stat-label">Total Events</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="activeEvents">-</div>
                    <div class="stat-label">Active Events</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalResponses">-</div>
                    <div class="stat-label">Total Responses</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="recentEvents">-</div>
                    <div class="stat-label">Created Today</div>
                </div>
            </div>

            <div class="events-section">
                <div class="filters">
                    <button class="filter-btn active" onclick="filterEvents('all')">All Events</button>
                    <button class="filter-btn" onclick="filterEvents('active')">Active</button>
                    <button class="filter-btn" onclick="filterEvents('closed')">Closed</button>
                    <button class="filter-btn" onclick="filterEvents('recent')">Recent (7 days)</button>
                    <input type="text" class="search-box" id="searchBox" placeholder="üîç Search events..." oninput="searchEvents()">
                </div>

                <div id="eventsTable">
                    <div class="loading">Loading events...</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyASUTmWxGbTSah_Pkxa_VIjJvppxc4dojE",
            authDomain: "pick-a-date-d0fc8.firebaseapp.com",
            databaseURL: "https://pick-a-date-d0fc8-default-rtdb.firebaseio.com",
            projectId: "pick-a-date-d0fc8",
            storageBucket: "pick-a-date-d0fc8.firebasestorage.app",
            messagingSenderId: "634466045922",
            appId: "1:634466045922:web:349c47805fc003390bf3bb",
            measurementId: "G-DQTMRQZFCC"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // CHANGE THIS PASSWORD TO SOMETHING SECURE
        const ADMIN_PASSWORD = "admin123";

        let allEvents = [];
        let currentFilter = 'all';

        function login() {
            const password = document.getElementById('adminPassword').value;
            if (password === ADMIN_PASSWORD) {
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('adminConsole').style.display = 'block';
                loadEvents();
            } else {
                document.getElementById('loginError').style.display = 'block';
            }
        }

        async function loadEvents() {
            try {
                const snapshot = await database.ref('events').once('value');
                const data = snapshot.val();
                
                if (!data) {
                    allEvents = [];
                    renderEvents();
                    return;
                }

                allEvents = Object.values(data).sort((a, b) => 
                    new Date(b.created) - new Date(a.created)
                );

                renderStats();
                renderEvents();

            } catch (error) {
                console.error('Error loading events:', error);
                document.getElementById('eventsTable').innerHTML = '<div class="no-events">Error loading events</div>';
            }
        }

        function renderStats() {
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            
            const activeEvents = allEvents.filter(e => {
                if (!e.maxResponses) return true;
                const responseCount = e.responseCount || 0;
                return responseCount < e.maxResponses;
            });

            const totalResponses = allEvents.reduce((sum, e) => sum + (e.responseCount || 0), 0);
            
            const recentEvents = allEvents.filter(e => {
                const created = new Date(e.created);
                return created >= today;
            });

            document.getElementById('totalEvents').textContent = allEvents.length;
            document.getElementById('activeEvents').textContent = activeEvents.length;
            document.getElementById('totalResponses').textContent = totalResponses;
            document.getElementById('recentEvents').textContent = recentEvents.length;
        }

        function filterEvents(filter) {
            currentFilter = filter;
            
            // Update button states
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');

            renderEvents();
        }

        function searchEvents() {
            renderEvents();
        }

        function renderEvents() {
            const searchTerm = document.getElementById('searchBox').value.toLowerCase();
            
            let filteredEvents = allEvents;

            // Apply filter
            if (currentFilter === 'active') {
                filteredEvents = filteredEvents.filter(e => {
                    if (!e.maxResponses) return true;
                    const responseCount = e.responseCount || 0;
                    return responseCount < e.maxResponses;
                });
            } else if (currentFilter === 'closed') {
                filteredEvents = filteredEvents.filter(e => {
                    if (!e.maxResponses) return false;
                    const responseCount = e.responseCount || 0;
                    return responseCount >= e.maxResponses;
                });
            } else if (currentFilter === 'recent') {
                const sevenDaysAgo = new Date();
                sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
                filteredEvents = filteredEvents.filter(e => {
                    const created = new Date(e.created);
                    return created >= sevenDaysAgo;
                });
            }

            // Apply search
            if (searchTerm) {
                filteredEvents = filteredEvents.filter(e => 
                    e.title.toLowerCase().includes(searchTerm) ||
                    (e.info && e.info.toLowerCase().includes(searchTerm))
                );
            }

            const container = document.getElementById('eventsTable');

            if (filteredEvents.length === 0) {
                container.innerHTML = '<div class="no-events">No events found</div>';
                return;
            }

            const tableHtml = `
                <table class="event-table">
                    <thead>
                        <tr>
                            <th>Event</th>
                            <th>Color</th>
                            <th>Date Range</th>
                            <th>Responses</th>
                            <th>Created</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${filteredEvents.map(event => {
                            const created = new Date(event.created).toLocaleDateString('en-US', {
                                month: 'short',
                                day: 'numeric',
                                year: 'numeric'
                            });

                            const dateRange = `${formatDate(event.dateBegin)} - ${formatDate(event.dateEnd)}`;
                            
                            const responseCount = event.responseCount || 0;
                            const maxResponses = event.maxResponses || '‚àû';
                            const isFull = event.maxResponses && responseCount >= event.maxResponses;
                            
                            return `
                                <tr>
                                    <td>
                                        <div class="event-title">${event.title}</div>
                                        ${event.info ? `<div class="event-meta">${event.info.substring(0, 60)}${event.info.length > 60 ? '...' : ''}</div>` : ''}
                                    </td>
                                    <td>
                                        <div class="color-badge" style="background: ${event.color}"></div>
                                    </td>
                                    <td>
                                        <div class="event-meta">${dateRange}</div>
                                    </td>
                                    <td>
                                        <span class="response-count ${isFull ? 'full' : ''}">${responseCount} / ${maxResponses}</span>
                                    </td>
                                    <td>
                                        <div class="event-meta">${created}</div>
                                    </td>
                                    <td>
                                        <button class="action-btn btn-view" onclick="viewEvent('${event.id}')">View</button>
                                        <button class="action-btn btn-dashboard" onclick="viewDashboard('${event.id}', '${event.adminKey}')">Dashboard</button>
                                        <button class="action-btn btn-delete" onclick="deleteEvent('${event.id}', '${event.title}')">Delete</button>
                                    </td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            `;

            container.innerHTML = tableHtml;
        }

        function formatDate(dateStr) {
            const date = new Date(dateStr + 'T00:00:00');
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        }

        function getBaseUrl() {
            const path = window.location.pathname;
            const origin = window.location.origin;
            let dir = path.substring(0, path.lastIndexOf('/') + 1);
            if (!dir || dir === '') {
                dir = '/';
            }
            return origin + dir;
        }

        function viewEvent(eventId) {
            const baseUrl = getBaseUrl();
            window.open(`${baseUrl}event.html?event=${eventId}`, '_blank');
        }

        function viewDashboard(eventId, adminKey) {
            const baseUrl = getBaseUrl();
            window.open(`${baseUrl}dashboard.html?event=${eventId}&admin=${adminKey}`, '_blank');
        }

        async function deleteEvent(eventId, eventTitle) {
            if (!confirm(`Delete "${eventTitle}"? This cannot be undone!`)) {
                return;
            }

            const confirmText = prompt('Type DELETE to confirm:');
            if (confirmText !== 'DELETE') {
                return;
            }

            try {
                await database.ref('events/' + eventId).remove();
                alert('Event deleted successfully!');
                loadEvents();
            } catch (error) {
                console.error('Error deleting event:', error);
                alert('Error deleting event');
            }
        }
    </script>
</body>
</html>
